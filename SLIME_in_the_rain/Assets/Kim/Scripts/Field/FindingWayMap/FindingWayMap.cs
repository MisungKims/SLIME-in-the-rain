/**
 * @brief 길 찾기 맵
 * @author 김미성
 * @date 22-08-08
 */

using System.Collections;
using System.Collections.Generic;
using UnityEngine;

[System.Serializable]
public class MapArray //행에 해당되는 이름
{
    public List<GameObject> map = new List<GameObject>();
}

public class FindingWayMap : MapManager
{
    #region 변수
    #region 싱글톤
    private static FindingWayMap instance = null;
    public static FindingWayMap Instance
    {
        get
        {
            if (null == instance)
            {
                return null;
            }
            return instance;
        }
    }
    #endregion

    private string trapTag = "Trap";
    private string roadTag = "Road";

    private int width;
    private int height;

    private int w;
    private int h;
    private int startIdx;
    private int rand;

    public bool isClear;

    enum EDirection { left, forward, right };
    EDirection direction;

    [SerializeField]
    private Transform RoadObject;

    [SerializeField]
    private List<MapArray> mapArrays = new List<MapArray>();      // Road 오브젝트의 배열

    private List<GameObject> roadList = new List<GameObject>();

    // 카메라
    private Camera mainCam;
    [SerializeField]
    private Camera movingCamera;
    [SerializeField]
    private Transform startCamPos;
    [SerializeField]
    private Transform endCamPos;

    private bool canMoveCam = true;
    private Vector3 offset;
    private float distance;

    [SerializeField]
    private GameObject wall;

    // 캐싱
    private Slime slime;
    #endregion

    #region 유니티 함수
    protected override void Awake()
    {
        if (null == instance)
        {
            instance = this;
        }
        else
        {
            Destroy(this.gameObject);
        }

        base.Awake();

        slime = Slime.Instance;
        mainCam = Camera.main;

        movingCamera.enabled = true;
        movingCamera.transform.localPosition = startCamPos.localPosition;

        wall.SetActive(false);

        isClear = false;

        InitArray();
        SetMap();

        StartCoroutine(ShowRoad());
        
        StartCoroutine(DetectFall());
    }
    #endregion

    #region 코루틴

    // 씬이 시작될 때 길을 알려줌
    IEnumerator ShowRoad()
    {
        slime.canMove = false;
        canMoveCam = true;
        StartCoroutine(MoveCamera());

        for (int i = 0; i < roadList.Count; i++)
        {
            yield return new WaitForSeconds(0.2f);

            roadList[i].GetComponent<RoadObject>().ChangeMesh(true);
        }

        yield return new WaitForSeconds(1.5f);

        canMoveCam = false;
        for (int i = 0; i < roadList.Count; i++)
        {
            roadList[i].GetComponent<RoadObject>().ChangeMesh(false);
        }
    }

    // 카메라가 앞으로 움직임
    IEnumerator MoveCamera()
    {
        yield return new WaitForSeconds(0.5f);

        offset = movingCamera.transform.localPosition - endCamPos.localPosition;
        distance = offset.sqrMagnitude;

        while (distance > 0.5f && canMoveCam)
        {
            movingCamera.transform.localPosition = Vector3.Lerp(movingCamera.transform.localPosition, endCamPos.localPosition, Time.deltaTime * 0.3f);

            yield return null;
        }

        movingCamera.enabled = false;
        slime.canMove = true;
    }

    // 슬라임이 떨어지면 초기 위치로 이동
    IEnumerator DetectFall()
    {
        while (true)
        {
            if (slime.IsInWater)
            {
                slime.transform.position = slimeSpawnPos.position;
            }

            yield return null;
        }
    }
    #endregion

    #region 함수
    // mapArrays 초기화
    private void InitArray()
    {
        width = RoadObject.childCount;
        height = RoadObject.GetChild(0).childCount;

        for (int i = 0; i < width; i++)
        {
            MapArray m = new MapArray();
            for (int j = 0; j < height; j++)
            {
                GameObject obj = RoadObject.GetChild(i).GetChild(j).gameObject;
                obj.tag = trapTag;
                m.map.Add(obj);
            }

            mapArrays.Add(m);
        }
    }

    // 맵 설정
    private void SetMap()
    {
        // 시작점과 끝점을 랜덤으로 설정
        startIdx = Random.Range(0, width);

        GameObject obj = mapArrays[width - 1].map[startIdx];
        obj.tag = roadTag;       // 시작점
        roadList.Add(obj);

        w = width - 1;      // 행
        h = startIdx;       // 열

        // 랜덤으로 길을 생성
        while (w > 0)
        {
            GenerateRoad();
        }
    }

    // 길 생성
    private void GenerateRoad()
    {
        rand = Random.Range(0, 3);
        direction = (EDirection)rand;
        GameObject obj;

        // 갈 수 있는 길(왼쪽, 오른쪽, 앞 방향)으로 길을 생성함

        switch (direction)
        {
            case EDirection.left:

                if (h > 0)
                {
                    obj = mapArrays[w].map[--h].gameObject;

                    if (roadList.Contains(obj))
                    {
                        h++;
                        break;
                    }

                    obj.tag = roadTag;
                    roadList.Add(obj);
                }
                break;
            case EDirection.forward:
                obj = mapArrays[--w].map[h].gameObject;

                if (roadList.Contains(obj))
                {
                    w--;
                    break;
                }

                obj.tag = roadTag;
                roadList.Add(obj);

                break;
            case EDirection.right:
                if (h < height - 1)
                {
                    obj = mapArrays[w].map[++h].gameObject;

                    if (roadList.Contains(obj))
                    {

                        h--;
                        break;
                    }

                    obj.tag = roadTag;
                    roadList.Add(obj);
                }

                break;
        }
    }

    // 맵 클리어 시 호출
    public override void ClearMap()
    {
        base.ClearMap();

        wall.SetActive(true);
    }
    #endregion
}
